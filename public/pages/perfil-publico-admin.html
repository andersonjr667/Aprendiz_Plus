<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/png" href="/public/images/logo.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil Público - Administrador - Aprendiz+</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/variables.css">
  <link rel="stylesheet" href="/public/css/main.css">
  <link rel="stylesheet" href="/public/css/perfil-admin.css">
  
  <script src="/public/js/auth.js" defer></script>
  <script src="/public/js/api.js" defer></script>
  
    <!-- AI Assistant -->
    <link rel="stylesheet" href="/public/css/ai-assistant.css">
</head>
<body class="page-container">
  
  <div id="header-container"></div>

  <main class="main-content" style="padding-top: 75px;">
    <!-- Header do Perfil Público -->
    <div class="public-profile-header">
      <div class="profile-cover-public" id="profileCoverPublic">
        <div class="profile-avatar-wrapper-public" id="avatarWrapperPublic" style="position:relative;">
          <!-- Círculos decorativos do dono (inseridos via JS se owner) -->
          <span id="ownerDecorCircles"></span>
          <img src="" alt="Avatar" class="profile-avatar-public" id="adminAvatar">
          <div class="admin-badge" id="adminBadge">
            <i class="fas fa-shield-alt"></i> ADMINISTRADOR
          </div>
        </div>
      </div>
      <div class="public-profile-info" id="publicProfileInfo">
        <h1 id="adminName">Carregando...</h1>
        <p class="profile-role-public">
          <i class="fas fa-shield-alt"></i> Administrador do Aprendiz+
        </p>
        <div class="profile-meta">
          <span id="adminEmail"></span>
          <span class="separator">•</span>
          <span>Membro desde <span id="adminJoined"></span></span>
        </div>
      </div>
    </div>

    <!-- Conteúdo do Perfil Público -->
    <div class="public-profile-content">
      <div class="content-grid">
        <!-- Coluna Principal -->
        <div class="main-column">
          <!-- Sobre -->
          <div class="profile-section">
            <h2><i class="fas fa-info-circle"></i> Sobre</h2>
            <div id="adminBio" class="bio-content">
              <p class="no-content">Este administrador ainda não adicionou uma biografia.</p>
            </div>
          </div>

          <!-- Responsabilidades -->
          <div class="profile-section">
            <h2><i class="fas fa-tasks"></i> Responsabilidades</h2>
            <button id="editResponsibilitiesBtn" class="btn btn-secondary" style="display:none; margin-bottom: 1rem;">
              <i class="fas fa-edit"></i> Editar Responsabilidades
            </button>
            <ul class="responsibilities-list">
              <li><i class="fas fa-check"></i> Gerenciamento de usuários e permissões</li>
              <li><i class="fas fa-check"></i> Moderação de conteúdo e vagas</li>
              <li><i class="fas fa-check"></i> Publicação de notícias oficiais</li>
              <li><i class="fas fa-check"></i> Monitoramento do sistema</li>
              <li><i class="fas fa-check"></i> Suporte à comunidade</li>
            </ul>
          </div>

          <!-- Notícias Publicadas -->
          <div class="profile-section">
            <h2><i class="fas fa-newspaper"></i> Notícias Publicadas</h2>
            <div id="adminNews" class="news-grid">
              <p class="loading">Carregando notícias...</p>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar-column">
          <!-- Contato -->
          <div class="profile-card">
            <h3><i class="fas fa-envelope"></i> Contato</h3>
            <div class="contact-info">
              <div class="contact-item" id="emailContact">
                <i class="fas fa-envelope"></i>
                <span>E-mail não disponível</span>
              </div>
              <div class="contact-item" id="phoneContact" style="display: none;">
                <i class="fas fa-phone"></i>
                <span></span>
              </div>
            </div>
          </div>

          <!-- Estatísticas -->
          <div class="profile-card">
            <h3><i class="fas fa-chart-bar"></i> Estatísticas</h3>
            <div class="stats-list">
              <div class="stat-item">
                <i class="fas fa-newspaper"></i>
                <div>
                  <strong id="newsCount">0</strong>
                  <span>Notícias Publicadas</span>
                </div>
              </div>
              <div class="stat-item">
                <i class="fas fa-calendar"></i>
                <div>
                  <strong id="memberSince">-</strong>
                  <span>Membro desde</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Ações Rápidas -->
          <div class="profile-card">
            <h3><i class="fas fa-bolt"></i> Ações Rápidas</h3>
            <div class="quick-actions">
              <a href="/noticias" class="action-btn">
                <i class="fas fa-newspaper"></i>
                Ver Todas as Notícias
              </a>
              <a href="/contato" class="action-btn">
                <i class="fas fa-envelope"></i>
                Entrar em Contato
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="messageContainer"></div>

  <script>
    // Edição de responsabilidades (apenas frontend)
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('editResponsibilitiesBtn');
      const list = document.querySelector('.responsibilities-list');
      if (!btn || !list) return;
      let editing = false;
      let textarea, saveBtn, cancelBtn;

      btn.addEventListener('click', () => {
        if (editing) return;
        editing = true;
        // Pega texto atual
        const items = Array.from(list.querySelectorAll('li')).map(li => li.textContent.trim());
        // Cria textarea
        textarea = document.createElement('textarea');
        textarea.value = items.join('\n');
        textarea.style.width = '100%';
        textarea.style.minHeight = '120px';
        textarea.style.marginBottom = '0.5rem';
        textarea.style.fontSize = '1rem';
        // Cria botões
        saveBtn = document.createElement('button');
        saveBtn.textContent = 'Salvar';
        saveBtn.className = 'btn btn-primary';
        saveBtn.style.marginRight = '0.5rem';
        cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancelar';
        cancelBtn.className = 'btn btn-secondary';
        // Limpa lista e insere editor
        list.innerHTML = '';
        list.appendChild(textarea);
        list.appendChild(saveBtn);
        list.appendChild(cancelBtn);

        saveBtn.onclick = () => {
          const lines = textarea.value.split(/\r?\n/).map(l => l.trim()).filter(l => l);
          list.innerHTML = lines.map(l => `<li><i class='fas fa-check'></i> ${l}</li>`).join('');
          editing = false;
        };
        cancelBtn.onclick = () => {
          list.innerHTML = items.map(l => `<li><i class='fas fa-check'></i> ${l}</li>`).join('');
          editing = false;
        };
      });
    });
    // Exibe botão de editar responsabilidades se for owner logado
    window.addEventListener('DOMContentLoaded', async () => {
      const token = Auth.getToken();
      if (!token) return;
      try {
        const res = await fetch('/api/users/me', { headers: { 'Authorization': `Bearer ${token}` }, credentials: 'include' });
        if (!res.ok) return;
        const me = await res.json();
        if (me.type === 'owner') {
          const btn = document.getElementById('editResponsibilitiesBtn');
          if (btn) btn.style.display = 'inline-block';
        }
      } catch (e) {}
    });
    // Initialize auth buttons
    window.addEventListener('DOMContentLoaded', () => {
      const authButtons = document.getElementById('authButtons');
      const token = Auth.getToken();
      
      if (token) {
        authButtons.innerHTML = `
          <a href="/perfil-admin">Meu Perfil</a>
          <button onclick="logout()" class="btn btn-secondary">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        `;
      } else {
        authButtons.innerHTML = `
          <a href="/login">Login</a>
          <a href="/register" class="btn btn-primary">Cadastrar</a>
        `;
      }
    });

    // Script para carregar dados do perfil público
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');

    async function loadPublicProfile() {
      try {
        const response = await fetch(`/api/users/${userId}/public`);
        if (!response.ok) {
          throw new Error('Erro ao carregar perfil');
        }
        const user = await response.json();
        // Preencher informações básicas
        document.getElementById('adminName').textContent = user.name;
        document.getElementById('adminEmail').textContent = user.email;
        // Avatar
        const avatar = user.avatarUrl || user.profilePhotoUrl || '/images/default-avatar.png';
        document.getElementById('adminAvatar').src = avatar;
        // Data de entrada
        const joinedDate = new Date(user.createdAt).toLocaleDateString('pt-BR', { 
          month: 'long', 
          year: 'numeric' 
        });
        document.getElementById('adminJoined').textContent = joinedDate;
        document.getElementById('memberSince').textContent = new Date(user.createdAt).toLocaleDateString('pt-BR');
        // Atualizar visual se for owner
        if (user.type === 'owner') {
          // Banner maior e colorido
          const cover = document.getElementById('profileCoverPublic');
          if (cover) {
            cover.style.background = 'linear-gradient(120deg, #36E131 0%, #2E935B 25%, #18F535 55%, #88F677 80%, #5DBBC3 100%)';
            cover.style.minHeight = '340px';
            cover.style.paddingTop = '3.5rem';
            cover.style.paddingBottom = '2.5rem';
            cover.style.boxShadow = '0 8px 32px 0 rgba(24,245,53,0.12), 0 1.5px 0 0 #36E131';
            cover.style.borderBottom = '6px solid #36E131';
            cover.style.position = 'relative';
            // Removido: círculos decorativos
            adminBadge.style.color = '#fff';
            adminBadge.style.fontWeight = '700';
            adminBadge.style.fontSize = '1.1rem';
            adminBadge.style.border = '2px solid #2E935B';
            adminBadge.style.boxShadow = '0 2px 8px rgba(54,225,49,0.12)';
          }
          // Título
          const profileRole = document.querySelector('.profile-role-public');
          if (profileRole) {
            profileRole.innerHTML = '<i class="fas fa-crown"></i> Proprietário do Aprendiz+';
            profileRole.style.color = '#fff';
            profileRole.style.fontSize = '1.15rem';
            profileRole.style.opacity = '0.95';
          }
          // Nome destaque
          const adminName = document.getElementById('adminName');
          if (adminName) {
            adminName.style.fontSize = '2.6rem';
            adminName.style.letterSpacing = '1.5px';
            adminName.style.color = '#fff';
            adminName.style.textShadow = '0 2px 12px rgba(46,147,91,0.18)';
          }
          // Responsabilidades
          const responsibilities = document.querySelector('.responsibilities-list');
          if (responsibilities) {
            responsibilities.innerHTML = `
              <li><i class="fas fa-check"></i> Proprietário e fundador da plataforma</li>
              <li><i class="fas fa-check"></i> Gerenciamento completo do sistema</li>
              <li><i class="fas fa-check"></i> Administração de administradores</li>
              <li><i class="fas fa-check"></i> Definição de políticas e diretrizes</li>
              <li><i class="fas fa-check"></i> Supervisão de todas as operações</li>
              <li><i class="fas fa-check"></i> Decisões estratégicas da plataforma</li>
            `;
          }
        }
        // Bio
        if (user.bio) {
          document.getElementById('adminBio').innerHTML = `<p>${user.bio}</p>`;
        }
        // Contato
        document.getElementById('emailContact').innerHTML = `
          <i class="fas fa-envelope"></i>
          <span>${user.email}</span>
        `;
        if (user.phone) {
          document.getElementById('phoneContact').style.display = 'flex';
          document.getElementById('phoneContact').querySelector('span').textContent = user.phone;
        }
        // Carregar notícias do admin
        loadAdminNews(userId);
      } catch (error) {
        console.error('Erro:', error);
        showMessage('Erro ao carregar perfil do administrador', 'error');
      }
    }

    async function loadAdminNews(adminId) {
      try {
        const response = await fetch(`/api/news?authorId=${adminId}`);
        if (!response.ok) throw new Error('Erro ao carregar notícias');
        const news = await response.json();
        const newsContainer = document.getElementById('adminNews');
        document.getElementById('newsCount').textContent = news.length;
        if (news.length === 0) {
          newsContainer.innerHTML = '<p class="no-content">Nenhuma notícia publicada ainda.</p>';
          return;
        }
        newsContainer.innerHTML = news.slice(0, 6).map(item => `
          <div class="news-card">
            ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.title}">` : ''}
            <div class="news-card-content">
              <h4>${item.title}</h4>
              <p class="news-date">
                <i class="fas fa-calendar"></i> 
                ${new Date(item.createdAt).toLocaleDateString('pt-BR')}
              </p>
              <a href="/news-detail?id=${item._id}" class="news-link">Ler mais →</a>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro:', error);
        document.getElementById('adminNews').innerHTML = '<p class="error">Erro ao carregar notícias</p>';
      }
    }

    // Verificar se o ID foi fornecido
    if (!userId) {
      showMessage('ID do administrador não fornecido', 'error');
    } else {
      loadPublicProfile();
    }
    // Edição de responsabilidades (salva no backend)
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('editResponsibilitiesBtn');
      const list = document.querySelector('.responsibilities-list');
      if (!btn || !list) return;
      let editing = false;
      let textarea, saveBtn, cancelBtn;

      btn.addEventListener('click', () => {
        if (editing) return;
        editing = true;
        // Pega texto atual
        const items = Array.from(list.querySelectorAll('li')).map(li => li.textContent.trim());
        // Cria textarea
        textarea = document.createElement('textarea');
        textarea.value = items.join('\n');
        textarea.style.width = '100%';
        textarea.style.minHeight = '120px';
        textarea.style.marginBottom = '0.5rem';
        textarea.style.fontSize = '1rem';
        // Cria botões
        saveBtn = document.createElement('button');
        saveBtn.textContent = 'Salvar';
        saveBtn.className = 'btn btn-primary';
        saveBtn.style.marginRight = '0.5rem';
        cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancelar';
        cancelBtn.className = 'btn btn-secondary';
        // Limpa lista e insere editor
        list.innerHTML = '';
        list.appendChild(textarea);
        list.appendChild(saveBtn);
        list.appendChild(cancelBtn);

        saveBtn.onclick = async () => {
          const lines = textarea.value.split(/\r?\n/).map(function(l) { return l.trim(); }).filter(function(l) { return l; });
          // Salva no backend
          const token = Auth.getToken();
          try {
            const res = await fetch('/api/users/' + userId + '/responsibilities', {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify({ responsibilities: lines })
            });
            if (!res.ok) throw new Error('Erro ao salvar responsabilidades');
            // Recarrega responsabilidades do backend para garantir consistência
            const updated = await res.json();
            list.innerHTML = (updated.responsibilities || lines).map(function(l) { return '<li><i class="fas fa-check"></i> ' + l + '</li>'; }).join('');
            editing = false;
          } catch (e) {
            alert('Erro ao salvar responsabilidades!');
            list.innerHTML = items.map(function(l) { return '<li><i class="fas fa-check"></i> ' + l + '</li>'; }).join('');
            editing = false;
          }
        };
        cancelBtn.onclick = function() {
          list.innerHTML = items.map(function(l) { return '<li><i class="fas fa-check"></i> ' + l + '</li>'; }).join('');
          editing = false;
        };
      });
    });
  </script>
    <!-- AI Assistant -->
    <script src="/public/js/ai-assistant.js"></script>
</body>
</html>
