<!DOCTYPE html>
<html lang="pt-br">
<head>
        <link rel="stylesheet" href="/public/css/header.css">
            <script src="/public/js/header.js" defer></script>
            <!-- Diagnostic: intercept redirects to /login and print stack trace (temporary) -->
            <script>
                (function(){
                    try {
                        const wrap = (label, fn) => function(url){
                            try {
                                if(String(url).includes('/login')){
                                    console.groupCollapsed('[DIAG] Redirect to /login detected - ' + label);
                                    console.trace();
                                    console.log('Redirect URL:', url);
                                    console.groupEnd();
                                }
                            } catch(e) { console.warn('[DIAG] error while tracing redirect', e); }
                            return fn.call(this, url);
                        };

                        if (window.location && typeof window.location.assign === 'function') {
                            window.location.assign = wrap('assign', window.location.assign.bind(window.location));
                        }
                        if (window.location && typeof window.location.replace === 'function') {
                            window.location.replace = wrap('replace', window.location.replace.bind(window.location));
                        }

                        const hrefDesc = Object.getOwnPropertyDescriptor(Location.prototype, 'href');
                        if (hrefDesc && typeof hrefDesc.set === 'function') {
                            const origHrefSet = hrefDesc.set;
                            Object.defineProperty(Location.prototype, 'href', {
                                configurable: true,
                                enumerable: true,
                                get: hrefDesc.get,
                                set: function(url){
                                    try {
                                        if (String(url).includes('/login')){
                                            console.groupCollapsed('[DIAG] Redirect to /login detected - href setter');
                                            console.trace();
                                            console.log('Redirect URL:', url);
                                            console.groupEnd();
                                        }
                                    } catch(e) { console.warn('[DIAG] error tracing href set', e); }
                                    return origHrefSet.call(this, url);
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('[DIAG] Failed to install redirect interceptors', e);
                    }
                })();
            </script>
    <link rel="icon" type="image/png" href="/public/images/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <title>Meu Dashboard | Aprendiz+</title>
    <link rel="stylesheet" href="/public/css/main.css">
    <link rel="stylesheet" href="/public/css/ui-dialogs.css">
    <link rel="stylesheet" href="/public/css/features.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 1.2rem 2rem 1.2rem;
            background: linear-gradient(120deg, #f8fafc 60%, #e8f5e9 100%);
            border-radius: 18px;
            box-shadow: 0 6px 32px rgba(46,204,113,0.07);
        }

        .page-header {
            margin-bottom: 2.5rem;
            text-align: left;
        }

        .page-title {
            font-size: 2.2rem;
            color: var(--brand-green);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .page-title i {
            color: var(--brand-green-dark);
        }

        .page-subtitle {
            color: var(--gray-600);
            font-size: 1.08rem;
            margin-bottom: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(120deg, #fff 80%, #e8f5e9 100%);
            padding: 1.7rem 1.3rem 1.3rem 1.3rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(46,204,113,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1.5px solid #e0f2f1;
            min-height: 140px;
        }

        .stat-card:hover {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 8px 32px rgba(46,204,113,0.13);
            border-color: #b2dfdb;
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-card-title {
            font-size: 0.875rem;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-card-icon.primary {
            background: rgba(46, 204, 113, 0.1);
            color: var(--brand-green);
        }

        .stat-card-icon.warning {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }

        .stat-card-icon.success {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }

        .stat-card-icon.danger {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .stat-card-value {
            font-size: 2.7rem;
            font-weight: 800;
            color: var(--brand-green-dark);
            margin-bottom: 0.25rem;
            letter-spacing: 1px;
        }

        .stat-card-label {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .dashboard-section {
            background: #fff;
            padding: 2rem 1.2rem 1.5rem 1.2rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(46,204,113,0.07);
            margin-bottom: 2.2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--brand-green-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: 0.5px;
        }

        .section-title i {
            color: var(--brand-green);
        }

        .applications-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .application-card {
            border: 1.5px solid #e0f2f1;
            border-radius: 12px;
            padding: 1.3rem 1.1rem 1.1rem 1.1rem;
            transition: all 0.3s;
            background: linear-gradient(120deg, #fff 80%, #e8f5e9 100%);
        }

        .application-card:hover {
            border-color: #26a69a;
            box-shadow: 0 8px 32px rgba(46,204,113,0.10);
        }

        .application-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .application-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--brand-green-dark);
            margin-bottom: 0.25rem;
            letter-spacing: 0.5px;
        }

        .application-company {
            font-size: 0.93rem;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .application-status {
            padding: 0.4rem 1.1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .application-status.pending {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }

        .application-status.accepted {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }

        .application-status.rejected {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .application-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .application-meta-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--gray-300);
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .loading-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .loading-state i {
            font-size: 3rem;
            color: var(--brand-green);
            margin-bottom: 1rem;
        }

        @media (max-width: 900px) {
            .dashboard-container {
                padding: 0.7rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .application-header {
                flex-direction: column;
                gap: 1rem;
            }
            .application-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            .dashboard-section {
                padding: 1.1rem 0.5rem 1rem 0.5rem;
            }
        }

        /* Application card layout with company chart */
        .application-card {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            padding: 1.3rem 1.1rem 1.1rem 1.1rem;
            background: linear-gradient(120deg, #fff 80%, #e8f5e9 100%);
            border-radius: 12px;
            border: 1.5px solid #e0f2f1;
        }

        .application-card .card-body {
            flex: 1 1 auto;
        }

        .company-chart {
            width: 120px;
            flex: 0 0 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .company-chart-canvas {
            width: 100% !important;
            height: 90px !important;
        }
    </style>
    <!-- AI Assistant -->
    <link rel="stylesheet" href="/public/css/ai-assistant.css">
</head>
<body class="page-container">
    <div id="header-container"></div>

    <main class="main-content">

        <div class="dashboard-container">
            <!-- Page Header -->
            <div id="header-container"></div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Total</span>
                        <div class="stat-card-icon primary">
                            <i class="fas fa-list"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="statTotal">0</div>
                    <div class="stat-card-label">candidaturas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Aguardando</span>
                        <div class="stat-card-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="statPending">0</div>
                    <div class="stat-card-label">aguardando resposta</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Aprovadas</span>
                        <div class="stat-card-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="statAccepted">0</div>
                    <div class="stat-card-label">candidaturas aceitas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Recusadas</span>
                        <div class="stat-card-icon danger">
                            <i class="fas fa-times-circle"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="statRejected">0</div>
                    <div class="stat-card-label">não aprovadas</div>
                </div>
            </div>

            <!-- Recent Applications -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-history"></i>
                        Minhas Candidaturas Recentes
                    </h2>
                    <a href="/vagas" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Buscar Vagas
                    </a>
                </div>

                <div id="applicationsContainer">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando suas candidaturas...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/public/js/ui-dialogs.js"></script>
    <script src="/js/chart.min.js"></script>
    <script src="/public/js/auth.js"></script>
    <script src="/public/js/api.js"></script>
    <script src="/public/js/global.js"></script>
    
    <!-- AI Assistant -->
    <script src="/public/js/ai-assistant.js"></script>
    
    <script>
        let applications = [];

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Get user applications (use apiFetch if available so token header is included)
                try {
                    if (window.apiFetch && typeof window.apiFetch === 'function') {
                        applications = await window.apiFetch('/users/me/applications');
                        console.log('Applications loaded (via apiFetch):', applications);
                    } else {
                        const headers = {};
                        const token = window.Auth && window.Auth.getToken ? window.Auth.getToken() : null;
                        if (token) headers['Authorization'] = 'Bearer ' + token;
                        const response = await fetch('/api/users/me/applications', { credentials: 'include', headers });
                        if (!response.ok) throw new Error('Failed to fetch applications');
                        applications = await response.json();
                        console.log('Applications loaded (via fetch):', applications);
                    }

                    updateStats();
                    displayApplications();
                } catch (err) {
                    console.error('Error loading dashboard:', err);
                    document.getElementById('applicationsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Erro ao carregar dados</h3>
                        <p>Não foi possível carregar suas candidaturas. Tente novamente mais tarde.</p>
                    </div>
                `;
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('applicationsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Erro ao carregar dados</h3>
                        <p>Não foi possível carregar suas candidaturas. Tente novamente mais tarde.</p>
                    </div>
                `;
            }
        }

        // Update stats
        function updateStats() {
            const total = applications.length;
            const pending = applications.filter(app => app.status === 'pending').length;
            const accepted = applications.filter(app => app.status === 'accepted').length;
            const rejected = applications.filter(app => app.status === 'rejected').length;

            const statTotal = document.getElementById('statTotal');
            const statPending = document.getElementById('statPending');
            const statAccepted = document.getElementById('statAccepted');
            const statRejected = document.getElementById('statRejected');
            if (statTotal) statTotal.textContent = total;
            if (statPending) statPending.textContent = pending;
            if (statAccepted) statAccepted.textContent = accepted;
            if (statRejected) statRejected.textContent = rejected;
        }

        // Display applications
        function displayApplications() {
            const container = document.getElementById('applicationsContainer');

            if (applications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Nenhuma candidatura ainda</h3>
                        <p>Você ainda não se candidatou a nenhuma vaga. Comece sua jornada agora!</p>
                        <a href="/vagas" class="btn btn-primary" style="margin-top: 1rem;">
                            <i class="fas fa-search"></i>
                            Explorar Vagas
                        </a>
                    </div>
                `;
                return;
            }

            // Sort by date (most recent first)
            const sortedApplications = [...applications].sort((a, b) => {
                const dateA = new Date(a.appliedAt || a.createdAt);
                const dateB = new Date(b.appliedAt || b.createdAt);
                return dateB - dateA;
            });

            const html = sortedApplications.map(app => createApplicationCard(app)).join('');
            container.innerHTML = `<div class="applications-list">${html}</div>`;
            // After injecting HTML, initialize company charts
            try { initCompanyCharts(); } catch (e) { console.warn('Failed to init company charts', e); }
        }

        // Create application card
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function createApplicationCard(app) {
            const statusMap = {
                'pending': 'Em Análise',
                'accepted': 'Aprovada',
                'rejected': 'Recusada'
            };

            const statusText = statusMap[app.status] || (app.status || 'Pendente');
            const appliedDate = new Date(app.appliedAt || app.appliedAtDate || app.createdAt || app.createdAtDate || Date.now());
            const formattedDate = appliedDate.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });

            // API may return different shapes: prefer nested job object, then top-level job_title/job_id
            const jobTitle = app.job && (app.job.title || app.job.name) ? (app.job.title || app.job.name) : (app.job_title || app.jobTitle || 'Vaga');
            const companyName = app.job && app.job.company && app.job.company.name ? app.job.company.name : (app.companyName || app.company_name || 'Empresa');
            const jobId = (app.job && (app.job._id || app.job.id)) || app.job_id || app.jobId || app.jobId;

            // Sanitize feedback to avoid XSS
            const feedbackSafe = app.feedback ? escapeHtml(app.feedback) : '';

            const appKey = escapeHtml(app._id || app.id || jobId || Math.random().toString(36).slice(2,8));
            return `
                <div class="application-card">
                    <div class="card-body">
                        <div class="application-header">
                            <div>
                                <h3 class="application-title">${escapeHtml(jobTitle)}</h3>
                                <p class="application-company">
                                    <i class="fas fa-building"></i>
                                    ${escapeHtml(companyName)}
                                </p>
                            </div>
                            <span class="application-status ${escapeHtml(app.status || '')}">${escapeHtml(statusText)}</span>
                        </div>
                        <div class="application-meta">
                            <span class="application-meta-item">
                                <i class="fas fa-calendar"></i>
                                Enviada em ${formattedDate}
                            </span>
                            ${app.feedback ? `
                                <span class="application-meta-item">
                                    <i class="fas fa-comment"></i>
                                    Feedback recebido
                                </span>
                            ` : ''}
                        </div>
                        ${app.feedback ? `
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-100); border-radius: 6px;">
                                <strong style="color: var(--text-dark); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-comment-dots"></i> Feedback da empresa:
                                </strong>
                                <p style="color: var(--gray-600); margin: 0;">${feedbackSafe}</p>
                            </div>
                        ` : ''}
                        ${jobId ? `
                            <div style="margin-top: 1rem;">
                                <a href="/vaga/${jobId}" class="btn btn-outline btn-sm">
                                    <i class="fas fa-eye"></i>
                                    Ver Vaga
                                </a>
                            </div>
                        ` : ''}
                    </div>
                    <div class="company-chart" data-company="${escapeHtml(companyName)}" data-appid="${appKey}">
                        <canvas id="company-chart-${appKey}" class="company-chart-canvas"></canvas>
                    </div>
                </div>
            `;
        }

        // Initialize company charts next to each application
        function initCompanyCharts() {
            if (typeof Chart === 'undefined') return;
            // build map of company key -> applications
            const map = {};
            applications.forEach(a => {
                const key = (a.job && a.job.company && (a.job.company._id || a.job.company.name)) || a.companyName || a.company_name || 'unknown';
                if (!map[key]) map[key] = [];
                map[key].push(a);
            });

            document.querySelectorAll('.company-chart').forEach(container => {
                try {
                    const company = container.getAttribute('data-company') || 'unknown';
                    const appId = container.getAttribute('data-appid');
                    const canvas = container.querySelector('canvas');
                    if (!canvas) return;
                    const apps = map[company] || [];
                    const accepted = apps.filter(x => x.status === 'accepted').length;
                    const pending = apps.filter(x => x.status === 'pending').length;
                    const rejected = apps.filter(x => x.status === 'rejected').length;
                    const data = [accepted, pending, rejected];

                    if (canvas._chartInstance) {
                        try { canvas._chartInstance.destroy(); } catch(e){}
                    }

                    canvas._chartInstance = new Chart(canvas.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Aprovadas','Aguardando','Recusadas'],
                            datasets: [{ data, backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'] }]
                        },
                        options: { plugins: { legend: { display: false } }, maintainAspectRatio: false, cutout: '65%' }
                    });
                } catch (e) {
                    console.warn('initCompanyCharts error', e);
                }
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });
    </script>
</body>
</html>
